# 简介

一个视频中有台词（字幕）、背景音乐、人物等信息。在这个demo中，我们以视频中的**字幕**为例，演示多模数据库如何用向量相似度匹配台词和视频。

# 准备工作

## 字幕文件

我们在视频网站上选择了4个视频，每个视频时长都在8-18分钟之间。然后，提取视频的字幕文件（srt格式）。srt格式的字幕文件的格式如下：

```
1
00:00:03,480 --> 00:00:04,839
all right we got to talk about Apple

2
00:00:04,839 --> 00:00:07,279
intelligence so Apple's made this

3
00:00:07,279 --> 00:00:09,160
promise this huge thing is coming that's
```

可以看到，每条字幕由3个部分组成：

* 字幕序号
* 时间戳：开始时间 --> 结束时间
* 字幕内容

## 字幕向量化和数据集生成

我们使用语义模型对字幕进行向量化。

首先要对字幕文件进行分割。出于简单性的考虑，可以直接按照字幕序号进行分割。这样，就可以充分利用srt字幕文件的信息，因为每条字幕都有序号、开始时间和结束时间。

所以，表可以这样设计：

|video_name     |subtitle_id|start_time|end_time|content         |vector          |
|---------------|-----------|----------|--------|----------------|----------------|
|Santa Mode...  |1          |4.319     |6.879   |hey everybody...|vec_f32('[...]')|

建表语句如下：

```sql
    CREATE TABLE subtitles (
        video_name TEXT NOT NULL,
        subtitle_id INTEGER NOT NULL,
        start_time REAL NOT NULL,
        end_time REAL NOT NULL,
        content TEXT NOT NULL,
        vector TEXT NOT NULL
    );
```

生成的插入语句数据集格式如下：

```sql
    INSERT INTO subtitles (video_name, subtitle_id, start_time, end_time, content, vector)
    VALUES (
        'Santa Mode & Video in Advanced Voice—12 Days of OpenAI_ Day 6 ',
        1,
        4.319,
        6.879,
        'hey everybody and welcome to day six',
        vec_f32('[-0.02215319,0.008599688, ... ,0.1465540.032805026,-0.04300473]')
    );
```

> 插入语句的数据集在``insert_subtitles.sql``文件

# 视频匹配查询

首先加载vec扩展，并用前面的建表语句建表，然后执行``insert_subtitles.sql``中的插入语句

用语义模型将待查询的台词向量化（必须和前面的台词用相同的语义模型并且保持向量的维度一致）

用下面的语句进行视频匹配查询：

结果是前5个相似度最高的台词。可以根据排名第一的台词的``video_name``得到对应的视频；或者用5个``video_name``中出现次数最多的视频名称作为匹配到的视频


```sql
    SELECT
        video_name,
        subtitle_id,
        start_time,
        end_time,
        content,
        vec_distance_L2(vec_f32(vector), vec_f32('[-0.0053440183,-0.054934345,0.028678812,0.010593503,0.090453856,0.004743561,0.009082756,-0.059153844,-0.03965492,0.0179954,0.037345715,0.031676088,0.03378677,-0.0069553615,0.00976828,0.008758573,0.04213444,-0.044140354,-0.061145566,-0.060317695,-0.02339856,-0.027040217,0.044597674,-0.0062237415,0.02310439,0.04263003,-0.017590305,0.0021383814,-0.07287012,-0.005257168,0.022687748,0.029539023,0.03373075,0.035800725,-0.06868042,-0.11320439,0.026268313,0.036305245,-0.010570694,-0.099404916,-0.08742575,-0.07517339,-0.012663128,0.083816774,0.024789838,0.023569658,-0.066193484,-0.032641716,0.020940905,0.07129822,-0.079283796,-0.05667166,0.007821154,0.060318228,0.041231718,0.070794515,-0.037181087,-0.0059473515,0.052154083,0.12930839,0.086220376,-0.07216608,0.053711794,0.03306991,0.009875538,0.052461416,0.016748983,-0.063072436,0.012570396,-0.15526657,0.042398997,0.019420039,0.030711276,-0.009883585,0.008998692,0.04486087,0.0017266622,-0.09043536,0.019550102,-0.045732345,-0.084541075,-0.009998826,-0.0028629745,0.07296685,0.08019761,-0.049314562,-0.010260248,-0.017294668,-0.033364233,0.02486326,-0.0070298547,-0.04736177,0.04423083,-0.05430383,-0.027959587,-0.02585403,-0.0059285015,-0.0970432,-0.08813227,0.04828895,-0.06900117,-0.019161882,-0.0026190206,-0.057123173,0.0764522,-0.046034783,0.074650824,-0.052459717,0.08133379,0.06525409,0.021051558,-0.043174468,0.030521054,-0.032267757,0.03190334,0.03697279,0.01682889,0.13102615,0.12817569,0.04084073,0.039558973,0.014725375,-0.026554856,-0.0383061,0.015820343,0.033875544,-0.04928771,-1.4770078e-33,-0.03912303,-0.02054161,-0.01518797,-0.033565808,-0.038152482,-0.12210674,-0.0032395907,0.036613826,-0.027093697,-0.01733026,-0.024284951,0.026534952,-0.024838474,0.013173929,0.05337787,-0.054139063,-0.03112091,0.072202325,0.0333112,-0.0024047939,0.06857962,-0.12668642,0.031101977,-0.028401861,0.087051824,0.07497241,0.04997907,-0.03933746,0.081566766,0.023017853,-0.026559561,0.038054783,5.0141007e-05,-0.036345772,-0.008647275,-0.025427267,-0.05208848,-0.03761563,0.08650965,0.06764825,-0.038119014,-0.028960895,-0.032958925,-0.034288727,-0.03325232,0.015226322,0.028865166,-0.046625398,0.0046350393,0.009020588,-0.053736154,-0.010870388,-0.0052163503,-0.0441188,-0.028115518,-0.005823346,0.014783423,-0.011601763,0.029516563,-0.0048757563,-0.026852163,0.006885559,-0.042328164,-0.046301857,-0.019197417,0.029443728,0.04052449,0.010990686,-0.059267197,0.12169156,-0.028639397,0.005687854,-0.014709039,-0.028414428,-0.104327604,0.01151742,-0.006716997,-0.035325203,-0.07057522,-0.052201465,0.010333155,-0.013947917,-0.00032637594,0.028462866,0.075022906,-0.0049195127,0.013520997,-0.028663553,-0.072964005,0.07013101,-0.058632806,0.03933017,-0.03178868,-0.026009211,-0.07036674,3.3688036e-34,-0.09164303,-0.09438583,-0.045175776,-0.016791783,-0.010683381,0.0038555725,0.029681461,0.105350435,-0.052437115,0.012196996,0.016378498,-0.031210316,-0.018570116,-0.069345646,0.024243873,0.06786315,-0.043569382,-0.028352123,-0.025997676,0.08342454,-0.1270595,-0.008387956,-0.0069805477,0.00088277133,-0.03562222,-0.011630611,0.010540599,0.036919087,0.016647186,-0.08982001,0.007967013,-0.060677726,-0.09920318,-0.031456612,0.02837552,0.0040873834,-0.032636546,-0.0016168165,-0.065617315,0.12200854,0.08452759,0.010771341,-0.11075957,0.03787776,0.009132757,0.06448548,-0.025478818,0.10707799,-0.0069570155,0.011790111,0.064552784,-0.030212283,-0.019354086,-0.0313043,-0.06646269,0.04523287,0.08219461,0.042022023,-0.008377997,0.030396363,0.003246514,-0.05563548,0.025778012,-0.062261686,0.033201296,0.0062483815,0.0076320893,0.04741323,-0.037353132,0.10327784,0.030389154,-0.050023567,0.013125685,-0.060592726,0.004469885,0.04973512,0.0025630633,-0.0556039,-0.07437605,-0.05056521,0.07674087,0.064695835,0.11364198,0.014736404,0.1449541,0.061607346,0.011824555,0.086668484,0.0003576961,-0.0003629409,-0.08762624,0.055092596,-0.07397322,-0.0005571756,-0.12721135,-1.7270475e-08,-0.0124883335,-0.023042861,0.06048295,0.006926889,0.058812067,0.021341473,-0.009787361,0.049638137,0.053425983,0.0019604054,0.0074021528,-0.045032356,-0.07758262,0.047905587,0.053211037,-0.006219221,0.008283616,0.04886209,0.027876606,-0.043864835,-0.02755022,0.043818202,-0.031079873,0.027985023,0.0025587678,-0.01001128,-0.02296326,0.050844215,0.03771123,0.013721482,-0.003707875,-0.0048462222,0.08241263,-0.04841513,0.08579037,0.024192149,-0.03658342,-0.006914572,-0.018823665,-0.034898177,-0.010827147,0.010622814,-0.060518194,0.012199707,0.015206651,0.009789463,-0.013294174,-0.109874465,0.06410499,0.034030605,0.013508582,-0.05566154,0.061356418,0.071137466,0.06948903,0.028860314,0.06175686,-0.09843751,-0.040236104,0.085347176,0.10871602,-0.02344481,0.04757859,-0.0062154685]')) AS distance
    FROM subtitles
    ORDER BY distance
    LIMIT 5;
```